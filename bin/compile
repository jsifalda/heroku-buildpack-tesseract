#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BP_DIR=$(cd $(dirname $0); cd ..; pwd)
PWD=$(pwd)

source $BP_DIR/bin/common.sh

echo "CACHE_DIR: $CACHE_DIR"

cd $PWD

# curl -O http://www.leptonica.org/source/leptonica-1.71.tar.gz
# tar -zxvf leptonica-1.71.tar.gz -C $BUILD_DIR/vendor

# cd $BUILD_DIR/vendor/leptonica-1.71

# ./configure --prefix=$BUILD_DIR/vendor/leptonica
# make
# make install

# cd $PWD

# curl -O https://tesseract-ocr.googlecode.com/files/tesseract-ocr-3.02.02.tar.gz
# tar -zxvf tesseract-ocr-3.02.02.tar.gz -C $BUILD_DIR/vendor

# cd $BUILD_DIR/vendor/tesseract-ocr

# ./autogen.sh
# ./configure
# make
# make install
# ldconfig

tar -zxvf tesseract.tar.gz -C $BUILD_DIR/vendor

echo $ENV_DIR

(
  if [ -d "$ENV_DIR" ]; then
    status "Exporting config vars to environment"
    export_env_dir $ENV_DIR
  fi
)

TESSERACT_DIR=$BUILD_DIR/vendor/tesseract-ocr

echo $TESSERACT_DIR

# (
#   if [ -d "$TESSERACT_DIR" ]; then
#     status "Exporting config vars to environment 2"
#     export_env_dir $TESSERACT_DIR
#   fi
# )

# make them executable
chmod +x $TESSERACT_DIR/bin/*
chmod +x $TESSERACT_DIR/lib/*

# Update the PATH

PATH=$TESSERACT_DIR/bin:$TESSERACT_DIR/lib:/usr/sbin/:$PATH

chmod +x /usr/sbin/*

echo "PATH: $PATH"

ldconfig

status "Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/vendor/tesseract-ocr/bin:\$HOME/vendor/tesseract-ocr/lib:/sbin:/usr/sbin:\$PATH\";" > $BUILD_DIR/.profile.d/tesseract.sh
