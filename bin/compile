#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

BP_DIR=$(cd $(dirname $0); cd ..; pwd)
PWD=$(pwd)

echo '!!!!!!!'
echo $BP_DIR
echo $PWD

source $BP_DIR/bin/common.sh

echo "CACHE_DIR: $CACHE_DIR"

cd $PWD

mkdir -p $BUILD_DIR/vendor

curl -O http://www.leptonica.org/source/leptonica-1.71.tar.gz
tar -zxvf leptonica-1.71.tar.gz -C $BUILD_DIR/vendor

cd $BUILD_DIR/vendor/leptonica-1.71

./configure --prefix=$BUILD_DIR/vendor/leptonica
make
make install
LIBLEPT_HEADERSDIR="\$HOME/vendor/leptonica/include $HOME/vendor/leptonica/include $BUILD_DIR/vendor/leptonica/include /usr/local/include /usr/include"

echo "----------------- HEADERS DIR ----------------"
echo $LIBLEPT_HEADERSDIR

cd $PWD

curl -O https://tesseract-ocr.googlecode.com/files/tesseract-ocr-3.02.02.tar.gz
tar -zxvf tesseract-ocr-3.02.02.tar.gz -C $BUILD_DIR/vendor

cd $BUILD_DIR/vendor/tesseract-ocr

./autogen.sh
./configure --with-extra-libraries=$BUILD_DIR/vendor/leptonica/lib/ --prefix=$BUILD_DIR/vendor/tesseract
make
make install

cd $PWD

ls -a

mkdir -p $BUILD_DIR/vendor/share
tar -zxvf tessdata.tar.gz -C $BUILD_DIR/vendor/share

(
  if [ -d "$ENV_DIR" ]; then
    status "Exporting config vars to environment"
    export_env_dir $ENV_DIR
  fi
)

# TESSERACT_DIR=$BUILD_DIR/vendor/tesseract-ocr

# echo $TESSERACT_DIR

# # make them executable
# chmod +x $TESSERACT_DIR/bin/*
# chmod +x $TESSERACT_DIR/lib/*

# # Update the PATH

# PATH=$TESSERACT_DIR/bin:$TESSERACT_DIR/lib:/usr/sbin/:/sbin:$PATH

status "Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
PROFILE_D=$BUILD_DIR/.profile.d/tesseract.sh
echo "export PATH=\"\$HOME/vendor/tesseract/bin:\$HOME/vendor/tesseract/lib:/sbin:/usr/sbin:\$PATH\";" > $PROFILE_D
echo "export LD_LIBRARY_PATH=\"\$HOME/vendor/tesseract/lib:\$LD_LIBRARY_PATH\";" >> $PROFILE_D
echo "export TESSDATA_PREFIX=\"\$HOME/vendor/share/\";" >> $PROFILE_D
